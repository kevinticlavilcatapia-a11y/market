<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Market POS v23: Flujo Caja Corregido</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #f59e0b;
            --nav-height: 60px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; display: flex; }

        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* LAYOUT */
        #app-layout { display: none; width: 100%; height: 100%; }
        .sidebar { width: 80px; background: #0f172a; display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 100; }
        .nav-btn { width: 60px; height: 60px; margin-bottom: 10px; background: transparent; border: none; color: #94a3b8; cursor: pointer; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.2s; }
        .nav-btn i { font-size: 24px; font-style: normal; margin-bottom: 4px; }
        .nav-btn span { font-size: 10px; font-weight: 600; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37,99,235,0.4); }

        @media (max-width: 768px) {
            #app-layout { flex-direction: column; }
            .sidebar { width: 100%; height: var(--nav-height); flex-direction: row; justify-content: space-around; padding: 0; position: fixed; bottom: 0; left: 0; border-top: 1px solid #1e293b; order: 2; }
            .nav-btn { width: auto; height: 100%; flex: 1; margin: 0; border-radius: 0; }
            .nav-btn.active { background: rgba(255,255,255,0.05); border-top: 3px solid var(--primary); box-shadow: none; }
        }

        .main-content { flex: 1; display: none; flex-direction: column; height: 100%; background: var(--bg); overflow: hidden; position: relative; }
        .main-content.active { display: flex; }
        .header { height: 55px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; }
        .title { font-size: 1.25rem; font-weight: 800; color: var(--text); }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; background: #e2e8f0; }
        .badge.open { background: #dcfce7; color: #166534; }
        .badge.closed { background: #fee2e2; color: #991b1b; }

        /* POS & BLOCKED STATE */
        .pos-container { display: flex; flex: 1; overflow: hidden; position: relative; }
        .products-area { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .cart-area { width: 380px; background: var(--surface); border-left: 1px solid var(--border); display: flex; flex-direction: column; z-index: 50; }
        
        /* BLOQUEO VISUAL DE POS */
        .pos-locked-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); z-index: 900;
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        .pos-locked-overlay.active { display: flex; }
        .lock-icon { font-size: 4rem; margin-bottom: 10px; }

        @media (max-width: 768px) { .main-content { height: calc(100vh - var(--nav-height)); } .pos-container { flex-direction: column; } .products-area { height: 60%; } .cart-area { width: 100%; height: 40%; border-left: none; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); } }

        /* UI Elements */
        .search-wrapper { display: flex; gap: 10px; }
        .search-input { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; }
        .btn-scan { background: var(--text); color: white; border: none; border-radius: 8px; width: 50px; cursor: pointer; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        .card { background: white; padding: 10px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; position: relative; display: flex; flex-direction: column; justify-content: space-between; height: 100%; }
        .card:active { border-color: var(--primary); transform: scale(0.98); }
        .card.no-stock { opacity: 0.6; pointer-events: none; background: #f1f5f9; }
        .badge-stock { position: absolute; top: 5px; right: 5px; font-size: 0.7rem; background: #f1f5f9; padding: 2px 5px; border-radius: 4px; }

        .cart-list { flex: 1; overflow-y: auto; padding: 10px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed var(--border); }
        .cart-footer { padding: 15px; border-top: 1px solid var(--border); background: white; flex-shrink: 0; }
        .btn-pay { width: 100%; background: var(--success); color: white; padding: 12px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .btn-pay:disabled { background: #cbd5e1; cursor: not-allowed; }

        .page-content { padding: 20px; overflow-y: auto; height: 100%; }
        .card-box { background: white; padding: 20px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 20px; }
        .input-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 10px; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-danger { background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }

        .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; background: white; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        th { background: #f8fafc; font-weight: 600; color: #64748b; }

        /* CONFIG PANEL */
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .role-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; background: #e0e7ff; color: var(--primary); font-size: 0.8rem; margin: 2px; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center; }
        .modal-overlay.open { display: flex; }
        .modal-content { background: white; width: 90%; max-width: 400px; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; position: relative; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; z-index: 10; }
        
        #scanner-container { width: 100%; height: 300px; background: black; }
        #print-area { display: none; }
        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2 style="color: var(--primary); margin-bottom: 20px;">MARKET POS</h2>
            <input type="text" id="user" class="login-input" placeholder="Usuario">
            <input type="password" id="pass" class="login-input" placeholder="Contrase√±a">
            <button class="login-btn" onclick="app.login()">INGRESAR</button>
            <p style="margin-top:15px; font-size:0.8rem; color:#64748b">
                Demo Admin: admin / 1234<br>
                Demo Cajero: cajero / 1234
            </p>
        </div>
    </div>

    <div id="app-layout">
        <nav class="sidebar" id="mainNav"></nav>

        <section id="pos" class="main-content">
            <div class="header">
                <span class="title">Ventas</span>
                <span class="badge closed" id="posStatus">Cerrado</span>
            </div>
            <div class="pos-container">
                <div id="posLock" class="pos-locked-overlay">
                    <div class="lock-icon">üîí</div>
                    <h3>Caja Cerrada</h3>
                    <p>Debes abrir turno para realizar ventas.</p>
                    <button class="btn-primary" onclick="app.nav('caja')">IR A ABRIR CAJA</button>
                </div>

                <div class="products-area">
                    <div class="search-wrapper">
                        <input type="text" id="search" class="search-input" placeholder="üîç Buscar nombre o c√≥digo..." onkeyup="app.renderPOS()">
                        <button class="btn-scan" onclick="app.startScanner()">üì∑</button>
                    </div>
                    <div class="grid" id="posGrid" style="margin-top: 15px;"></div>
                </div>
                <div class="cart-area">
                    <div style="padding:15px; border-bottom:1px solid #eee; font-weight:bold;">Ticket</div>
                    <div class="cart-list" id="cartList"></div>
                    <div class="cart-footer">
                        <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:bold; margin-bottom:10px;">
                            <span>Total</span><span>S/ <span id="cartTotal">0.00</span></span>
                        </div>
                        <button id="btnCheckout" class="btn-pay" onclick="app.openPay()" disabled>COBRAR</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="caja" class="main-content">
            <div class="header"><span class="title">Caja</span><span class="badge closed" id="cajaStatus">Cerrado</span></div>
            <div class="page-content">
                <div id="viewClosed" class="card-box" style="text-align:center;">
                    <h3>üîê Abrir Turno</h3>
                    <p style="color:#64748b; margin-bottom:15px;">Ingresa el dinero base para iniciar ventas.</p>
                    <input type="number" id="initCash" class="input-control" placeholder="Fondo Inicial (S/)" value="">
                    <button class="btn-primary" style="width:100%" onclick="app.openBox()">ABRIR CAJA E INICIAR</button>
                </div>
                <div id="viewOpen" style="display:none;">
                    <div class="card-box" style="background:#f0fdfa; border-color:var(--success);">
                        <h2 style="text-align:center; color:var(--success); margin:0;">S/ <span id="lblCash">0.00</span></h2>
                        <p style="text-align:center; margin:0; color:#64748b;">Efectivo en Caj√≥n</p>
                    </div>
                    <div class="card-box">
                        <h4>Movimientos</h4>
                        <div style="display:flex; gap:10px;">
                            <select id="movType" class="input-control" style="width:auto;"><option value="out">üî¥ Salida</option><option value="in">üü¢ Entrada</option></select>
                            <input id="movDesc" class="input-control" placeholder="Motivo" style="flex:1;">
                            <input id="movAmnt" type="number" class="input-control" placeholder="Monto" style="width:100px;">
                            <button class="btn-primary" onclick="app.addMove()">OK</button>
                        </div>
                        <div id="movList" style="margin-top:10px; font-size:0.85rem;"></div>
                    </div>
                    <div class="card-box" style="border-left:4px solid var(--danger);">
                        <h4>Cerrar Turno</h4>
                        <div style="display:flex; gap:10px; align-items:flex-end;">
                            <div style="flex:1;"><input type="number" id="realCash" class="input-control" placeholder="Efectivo Real" style="margin:0;"></div>
                            <button class="btn-danger" style="height:42px;" onclick="app.closeBox()">CERRAR</button>
                        </div>
                    </div>
                </div>
                <h3>Historial</h3>
                <div class="table-wrap"><table><thead><tr><th>ID</th><th>Inicio</th><th>Ventas</th><th>Dif.</th><th>PDF</th></tr></thead><tbody id="boxHistory"></tbody></table></div>
            </div>
        </section>

        <section id="inv" class="main-content">
            <div class="header"><span class="title">Inventario</span></div>
            <div class="page-content">
                <div class="card-box">
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <input id="pId" placeholder="C√≥digo" class="input-control" style="width:100px;">
                        <input id="pName" placeholder="Nombre" class="input-control" style="flex:1;">
                        <input id="pPrice" placeholder="Precio" type="number" class="input-control" style="width:80px;">
                        <input id="pStock" placeholder="Stock" type="number" class="input-control" style="width:70px;">
                        <button class="btn-primary" onclick="app.addProd()">Guardar</button>
                    </div>
                </div>
                <div class="table-wrap"><table><thead><tr><th>ID</th><th>Producto</th><th>Precio</th><th>Stock</th><th>Acci√≥n</th></tr></thead><tbody id="invTable"></tbody></table></div>
            </div>
        </section>

        <section id="conf" class="main-content">
            <div class="header"><span class="title">Configuraci√≥n</span></div>
            <div class="page-content">
                <div class="config-grid">
                    <div class="card-box">
                        <h4>Gesti√≥n de Roles</h4>
                        <div style="display:flex; gap:10px;">
                            <input id="newRoleName" class="input-control" placeholder="Nombre Rol">
                            <button class="btn-primary" onclick="app.addRole()">+</button>
                        </div>
                        <div style="margin-bottom:10px;">
                            <label><input type="checkbox" class="chk-perm" value="pos">Ventas</label>
                            <label><input type="checkbox" class="chk-perm" value="caja">Caja</label>
                            <label><input type="checkbox" class="chk-perm" value="inv">Stock</label>
                            <label><input type="checkbox" class="chk-perm" value="conf">Config</label>
                        </div>
                        <div id="rolesList"></div>
                    </div>
                    <div class="card-box">
                        <h4>Gesti√≥n de Usuarios</h4>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <input id="uUser" class="input-control" placeholder="Usuario" style="flex:1;">
                            <input id="uPass" class="input-control" placeholder="Clave" style="width:100px;">
                            <select id="uRole" class="input-control" style="width:120px;"></select>
                            <button class="btn-primary" onclick="app.addUser()">Crear</button>
                        </div>
                        <div class="table-wrap" style="margin-top:10px;">
                            <table><thead><tr><th>Usuario</th><th>Rol</th><th>Acci√≥n</th></tr></thead><tbody id="usersTable"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="rep" class="main-content"><div class="header"><span class="title">Reportes</span></div><div class="page-content"><div class="table-wrap"><table><thead><tr><th>ID</th><th>Fecha</th><th>Total</th><th>Pago</th></tr></thead><tbody id="repTable"></tbody></table></div></div></section>
    </div>

    <div id="scanModal" class="modal-overlay">
        <div class="modal-content" style="background:black;">
            <span class="modal-close" onclick="app.stopScanner()" style="color:white;">‚úï</span>
            <div id="scanner-container"></div>
            <p style="color:white; text-align:center; padding:10px;">Apunta al c√≥digo de barras</p>
        </div>
    </div>

    <div id="payModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('payModal').classList.remove('open')">‚úï</span>
            <div style="padding:20px; text-align:center;">
                <h3>Total: S/ <span id="modalTotal">0.00</span></h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">
                    <button class="input-control" onclick="app.pay('Efectivo')">üíµ Efectivo</button>
                    <button class="input-control" onclick="app.pay('Yape')">üì± Yape</button>
                    <button class="input-control" onclick="app.pay('Plin')">üîÑ Plin</button>
                    <button class="input-control" onclick="app.pay('Tarjeta')">üí≥ Tarjeta</button>
                </div>
            </div>
        </div>
    </div>

    <div id="print-area"></div>

    <script>
        const app = {
            data: {
                roles: JSON.parse(localStorage.getItem('pos_roles_v23')) || [{id:1, name:'Admin', perms:['pos','caja','inv','conf','rep']},{id:2, name:'Cajero', perms:['pos','caja']}],
                users: JSON.parse(localStorage.getItem('pos_users_v23')) || [{id:1, user:'admin', pass:'1234', roleId:1}, {id:2, user:'cajero', pass:'1234', roleId:2}],
                db: JSON.parse(localStorage.getItem('pos_db_v23')) || [],
                sales: JSON.parse(localStorage.getItem('pos_sales_v23')) || [],
                sessions: JSON.parse(localStorage.getItem('pos_sessions_v23')) || [],
                cart: [],
                currentUser: null,
                html5QrcodeScanner: null
            },

            // --- AUTH & FLOW ---
            login: () => {
                const u = document.getElementById('user').value;
                const p = document.getElementById('pass').value;
                const user = app.data.users.find(x => x.user === u && x.pass === p);
                
                if (user) {
                    app.data.currentUser = user;
                    const role = app.data.roles.find(r => r.id == user.roleId);
                    
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('app-layout').style.display = 'flex';
                    app.buildMenu(role);

                    // L√ìGICA DE REDIRECCI√ìN INTELIGENTE
                    const activeSession = app.data.sessions.find(s => s.status === 'open');
                    
                    // Si es cajero y no hay caja abierta, forzar ir a Caja
                    if (!activeSession && role.name === 'Cajero') {
                        app.nav('caja');
                    } else {
                        // Si hay caja abierta o es admin, ir al primer m√≥dulo disponible (usualmente POS)
                        app.nav(role.perms[0]);
                    }
                    
                    // Inicializar estado visual de caja
                    app.updateGlobalBoxState();

                } else alert("Error");
            },

            buildMenu: (role) => {
                const menu = document.getElementById('mainNav'); menu.innerHTML = '';
                const allMods = [
                    {id:'pos', i:'üõí', l:'Ventas'},
                    {id:'caja', i:'üè™', l:'Caja'},
                    {id:'inv', i:'üì¶', l:'Stock'},
                    {id:'rep', i:'üìä', l:'Rep'},
                    {id:'conf', i:'‚öôÔ∏è', l:'Config'}
                ];

                allMods.forEach(m => {
                    if (role.perms.includes(m.id)) {
                        const btn = document.createElement('button');
                        btn.className = 'nav-btn';
                        btn.onclick = () => app.nav(m.id);
                        btn.innerHTML = `<i>${m.i}</i><span>${m.l}</span>`;
                        menu.appendChild(btn);
                    }
                });
                
                // Logout btn
                const out = document.createElement('button');
                out.className = 'nav-btn';
                out.innerHTML = `<i>üö™</i><span>Salir</span>`;
                out.onclick = () => location.reload();
                menu.appendChild(out);
            },

            nav: (id) => {
                document.querySelectorAll('.main-content').forEach(e => e.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
                const target = document.getElementById(id);
                if(target) target.classList.add('active');
                
                const btns = document.querySelectorAll('.nav-btn');
                btns.forEach(b => { if(b.innerHTML.includes(id=='pos'?'Ventas':id=='caja'?'Caja':id=='inv'?'Stock':id=='conf'?'Config':'Rep')) b.classList.add('active'); });

                if(id=='pos') { app.renderPOS(); app.updateGlobalBoxState(); }
                if(id=='caja') app.checkBox();
                if(id=='inv') app.renderInv();
                if(id=='conf') app.renderConfig();
                if(id=='rep') app.renderRep();
            },

            // --- BOX LOGIC ---
            updateGlobalBoxState: () => {
                const act = app.data.sessions.find(s => s.status === 'open');
                const badge = document.getElementById('posStatus');
                const lock = document.getElementById('posLock');
                const btnPay = document.getElementById('btnCheckout');

                if (act) {
                    badge.className = 'badge open';
                    badge.innerText = 'Abierto';
                    lock.classList.remove('active'); // Quitar candado
                    btnPay.disabled = app.data.cart.length === 0;
                } else {
                    badge.className = 'badge closed';
                    badge.innerText = 'Cerrado';
                    lock.classList.add('active'); // Mostrar candado
                    btnPay.disabled = true;
                }
            },

            openBox: () => {
                const v = parseFloat(document.getElementById('initCash').value);
                if (isNaN(v)) return alert("Ingrese monto inicial");
                
                app.data.sessions.push({
                    id: Date.now(), start: new Date(), end: null,
                    init: v, salesTotal: 0, salesCash: 0, salesYape: 0, salesPlin: 0, salesCard: 0,
                    moves: 0, expected: v, real: 0, diff: 0, status: 'open', movements: []
                });
                
                app.save();
                app.checkBox();
                app.updateGlobalBoxState();
                
                // REDIRECCI√ìN AUTOM√ÅTICA A VENTAS AL ABRIR
                alert("‚úÖ Caja Abierta. Redirigiendo a Ventas...");
                app.nav('pos');
            },

            checkBox: () => {
                const act = app.data.sessions.find(s => s.status === 'open');
                const status = act ? 'Abierto' : 'Cerrado';
                const cls = act ? 'open' : 'closed';
                
                document.getElementById('cajaStatus').innerText = status;
                document.getElementById('cajaStatus').className = 'badge ' + cls;
                
                document.getElementById('viewClosed').style.display = act ? 'none' : 'block';
                document.getElementById('viewOpen').style.display = act ? 'block' : 'none';

                if (act) {
                    document.getElementById('lblCash').innerText = act.expected.toFixed(2);
                    document.getElementById('movList').innerHTML = (act.movements || []).map(m => `<div>${m.desc}: ${m.amount}</div>`).join('');
                }
                
                document.getElementById('boxHistory').innerHTML = [...app.data.sessions].reverse().map(s => 
                    `<tr><td>${s.id}</td><td>${new Date(s.start).toLocaleTimeString()}</td><td>${s.salesTotal.toFixed(2)}</td><td>${s.diff || '-'}</td><td>PDF</td></tr>`
                ).join('');
            },

            addMove: () => {
                const act = app.data.sessions.find(s => s.status === 'open'); if(!act) return;
                const t=document.getElementById('movType').value, d=document.getElementById('movDesc').value, a=parseFloat(document.getElementById('movAmnt').value);
                if(!d || isNaN(a)) return;
                const val = t === 'in' ? a : -a;
                act.moves += val; act.expected += val;
                act.movements.push({type:t, desc:d, amount:val});
                app.save(); app.checkBox(); app.updateGlobalBoxState();
                document.getElementById('movDesc').value = ''; document.getElementById('movAmnt').value = '';
            },

            closeBox: () => {
                const act = app.data.sessions.find(s => s.status === 'open'); if(!act) return;
                const r = parseFloat(document.getElementById('realCash').value);
                if(isNaN(r)) return alert("Ingrese monto real");
                if(!confirm("¬øCerrar Turno?")) return;
                act.real = r; act.diff = r - act.expected; act.end = new Date(); act.status = 'closed';
                app.save(); app.checkBox(); app.updateGlobalBoxState(); document.getElementById('realCash').value = '';
            },

            // --- POS ---
            renderPOS: () => {
                const q = document.getElementById('search').value.toLowerCase();
                document.getElementById('posGrid').innerHTML = app.data.db.filter(p => p.name.toLowerCase().includes(q) || p.id.toString().includes(q)).map(p => `
                    <div class="card ${p.stock<=0?'no-stock':''}" onclick="app.addToCart(${p.id})">
                        <span class="badge-stock">${p.stock}</span>
                        <div style="font-weight:bold;font-size:0.9rem;">${p.name}</div>
                        <div class="card-price">S/ ${p.price.toFixed(2)}</div>
                    </div>
                `).join('');
            },
            addToCart: (id) => {
                const p = app.data.db.find(x => x.id == id);
                const i = app.data.cart.find(x => x.id == id);
                if (i) { if(i.qty >= p.stock) return alert('Max Stock'); i.qty++; }
                else app.data.cart.push({...p, qty:1});
                app.renderCart();
            },
            renderCart: () => {
                let t = 0;
                document.getElementById('cartList').innerHTML = app.data.cart.map(i => {
                    t += i.price * i.qty;
                    return `<div class="cart-item"><div>${i.name}<br><small>S/ ${i.price}</small></div><div style="display:flex;align-items:center;gap:5px;"><b>${i.qty}</b><button class="btn-danger" style="padding:2px 6px;" onclick="app.remCart(${i.id})">x</button></div></div>`;
                }).join('');
                document.getElementById('cartTotal').innerText = t.toFixed(2);
                
                // Habilitar bot√≥n solo si hay items Y hay caja abierta
                const act = app.data.sessions.find(s => s.status === 'open');
                document.getElementById('btnCheckout').disabled = (app.data.cart.length === 0 || !act);
            },
            remCart: (id) => { app.data.cart = app.data.cart.filter(x => x.id != id); app.renderCart(); },
            openPay: () => { document.getElementById('modalTotal').innerText = document.getElementById('cartTotal').innerText; document.getElementById('payModal').classList.add('open'); },
            pay: (m) => {
                const act = app.data.sessions.find(s => s.status === 'open');
                if(!act) return alert('Caja cerrada');
                const t = parseFloat(document.getElementById('cartTotal').innerText);
                
                act.salesTotal += t;
                if(m=='Efectivo') { act.salesCash = (act.salesCash||0)+t; act.expected += t; } 
                else if(m=='Yape') act.salesYape = (act.salesYape||0)+t;
                else if(m=='Plin') act.salesPlin = (act.salesPlin||0)+t;
                else act.salesCard = (act.salesCard||0)+t;

                app.data.sales.push({id:Date.now(), date:new Date().toLocaleString(), total:t, method:m});
                
                app.data.cart.forEach(c => {
                    const p = app.data.db.find(x => x.id == c.id);
                    p.stock -= c.qty;
                });

                app.data.cart = []; app.save(); app.renderCart(); app.renderPOS(); app.updateGlobalBoxState();
                document.getElementById('payModal').classList.remove('open');
                alert('Venta Registrada');
            },

            // --- OTHERS ---
            startScanner: () => {
                document.getElementById('scanModal').classList.add('open');
                app.html5QrcodeScanner = new Html5QrcodeScanner("scanner-container", { fps: 10, qrbox: 250 });
                app.html5QrcodeScanner.render((txt) => {
                    app.stopScanner();
                    const p = app.data.db.find(x => x.id == txt);
                    if (p) { app.addToCart(p.id); alert(`Producto: ${p.name}`); } 
                    else if(confirm('Producto no existe. ¬øCrear?')) { app.nav('inv'); document.getElementById('pId').value = txt; }
                });
            },
            stopScanner: () => { if(app.html5QrcodeScanner) app.html5QrcodeScanner.clear(); document.getElementById('scanModal').classList.remove('open'); },

            addProd: () => {
                const id = document.getElementById('pId').value, name = document.getElementById('pName').value, price = parseFloat(document.getElementById('pPrice').value), stock = parseInt(document.getElementById('pStock').value);
                if(name && price) {
                    app.data.db.push({id:id||Date.now(), name, price, stock:stock||0, type:'product'});
                    app.save(); app.renderInv();
                }
            },
            renderInv: () => { document.getElementById('invTable').innerHTML = app.data.db.map(p => `<tr><td>${p.id}</td><td>${p.name}</td><td>${p.price}</td><td>${p.stock}</td><td><button class="btn-danger" onclick="app.delProd(${p.id})">X</button></td></tr>`).join(''); },
            delProd: (id) => { if(confirm('Eliminar?')){ app.data.db = app.data.db.filter(x => x.id != id); app.save(); app.renderInv(); } },
            
            renderConfig: () => {
                document.getElementById('rolesList').innerHTML = app.data.roles.map(r => `<span class="role-badge" style="background:#e0e7ff;margin:2px;padding:2px 5px;border-radius:4px;">${r.name}</span>`).join('');
                document.getElementById('uRole').innerHTML = app.data.roles.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
                document.getElementById('usersTable').innerHTML = app.data.users.map(u => `<tr><td>${u.user}</td><td>${app.data.roles.find(r=>r.id==u.roleId)?.name}</td><td><button class="btn-danger" onclick="app.delUser(${u.id})">X</button></td></tr>`).join('');
            },
            addRole: () => {
                const n = document.getElementById('newRoleName').value;
                const p = Array.from(document.querySelectorAll('.chk-perm:checked')).map(c => c.value);
                if(n) { app.data.roles.push({id:Date.now(), name:n, perms:p}); app.save(); app.renderConfig(); }
            },
            addUser: () => {
                const u = document.getElementById('uUser').value, p = document.getElementById('uPass').value, r = document.getElementById('uRole').value;
                if(u && p) { app.data.users.push({id:Date.now(), user:u, pass:p, roleId:r}); app.save(); app.renderConfig(); }
            },
            delUser: (id) => { if(id>2 && confirm('Del?')){ app.data.users = app.data.users.filter(u => u.id != id); app.save(); app.renderConfig(); } },
            renderRep: () => { document.getElementById('repTable').innerHTML = [...app.data.sales].reverse().map(s => `<tr><td>${s.id}</td><td>${s.date}</td><td>${s.total}</td><td>${s.method}</td></tr>`).join(''); },

            save: () => {
                localStorage.setItem('pos_db_v23', JSON.stringify(app.data.db));
                localStorage.setItem('pos_sales_v23', JSON.stringify(app.data.sales));
                localStorage.setItem('pos_sessions_v23', JSON.stringify(app.data.sessions));
                localStorage.setItem('pos_users_v23', JSON.stringify(app.data.users));
                localStorage.setItem('pos_roles_v23', JSON.stringify(app.data.roles));
            }
        };
        
        document.getElementById('search').addEventListener('keyup', app.renderPOS);
    </script>
</body>
</html>
