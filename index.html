<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market POS v14: Auditor√≠a & Cierre Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #f59e0b;
            --yape: #742284;
            --plin: #00d1d1;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 80px; background: #0f172a; display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 10; }
        .nav-btn { background: transparent; border: none; color: #94a3b8; font-size: 26px; cursor: pointer; padding: 15px; margin-bottom: 10px; border-radius: 12px; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 0 15px rgba(37, 99, 235, 0.4); }

        /* LAYOUT */
        .main-content { flex: 1; display: none; flex-direction: column; height: 100%; position: relative; }
        .main-content.active { display: flex; }
        .header { background: var(--surface); padding: 0 25px; height: 60px; display: flex; align-items: center; border-bottom: 1px solid var(--border); justify-content: space-between; }
        .title { font-size: 1.5rem; font-weight: 800; margin: 0; color: var(--text); letter-spacing: -0.5px; }
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; }
        .status-open { background: #dcfce7; color: #166534; }
        .status-closed { background: #fee2e2; color: #991b1b; }

        /* POS */
        .pos-layout { display: flex; height: calc(100% - 60px); }
        .products-section { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .search-input { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; }
        .search-input:focus { border-color: var(--primary); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .card { background: white; padding: 12px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; position: relative; }
        .card:hover { transform: translateY(-2px); border-color: var(--primary); }
        .card.no-stock { opacity: 0.6; pointer-events: none; background: #f1f5f9; }
        .price-tag { font-size: 1.1rem; font-weight: 700; color: var(--primary); margin-top: 5px; }
        .badge-stock { font-size: 0.75rem; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; color: #475569; position: absolute; top: 10px; right: 10px;}
        .cat-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        .cat-btn { background: white; border: 1px solid var(--border); padding: 6px 14px; border-radius: 20px; cursor: pointer; }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* CART */
        .cart-section { width: 360px; background: white; border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .cart-list { flex: 1; overflow-y: auto; padding: 15px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed var(--border); }
        .qty-box { width: 35px; text-align: center; border: 1px solid var(--border); border-radius: 4px; padding: 4px; }
        .cart-total { padding: 20px; background: #f8fafc; border-top: 1px solid var(--border); }
        .btn-pay { width: 100%; background: var(--success); color: white; padding: 15px; border: none; border-radius: 8px; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
        .btn-pay:disabled { background: #cbd5e1; cursor: not-allowed; }

        /* UI ELEMENTS */
        .container-fluid { padding: 20px; overflow-y: auto; height: calc(100% - 60px); max-width: 1200px; margin: 0 auto; width: 100%; }
        .form-card { background: white; padding: 20px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 20px; }
        .input-group label { display: block; font-size: 0.85rem; margin-bottom: 5px; font-weight: 600; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; border: none; color: white; margin-left: 5px;}
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); margin-bottom: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #f1f5f9; font-weight: 600; }

        /* STATS & KARDEX */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: 800; color: var(--primary); margin-top: 5px; }
        .kardex-in { color: var(--success); font-weight: bold; }
        .kardex-out { color: var(--danger); font-weight: bold; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; backdrop-filter: blur(2px); align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal-content { background: white; width: 90%; max-width: 450px; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .modal-header { padding: 15px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        .pay-methods { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .btn-method { padding: 20px; font-size: 1.1rem; border: none; border-radius: 10px; color: white; cursor: pointer; font-weight: bold; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .bg-cash { background: var(--success); } .bg-yape { background: var(--yape); } .bg-plin { background: var(--plin); } .bg-card { background: var(--text); }
        
        /* PRINT */
        #print-area { display: none; }
        @media print { @page { margin: 0; } body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; font-family: monospace; font-size: 12px; padding: 10px; } .ticket-container { max-width: 300px; margin: 0 auto; } .t-dashed { border-top: 1px dashed black; margin: 5px 0; } .t-row { display: flex; justify-content: space-between; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <button class="nav-btn active" onclick="nav('pos')" title="Ventas">üõí</button>
        <button class="nav-btn" onclick="nav('caja')" title="Caja">üè™</button>
        <button class="nav-btn" onclick="nav('inv')" title="Inventario">üì¶</button>
        <button class="nav-btn" onclick="nav('audit')" title="Auditor√≠a">üëÅÔ∏è</button>
        <button class="nav-btn" onclick="nav('rep')" title="Reportes">üìä</button>
    </div>

    <div id="pos" class="main-content active">
        <div class="header">
            <h2 class="title">Market POS</h2>
            <div id="posBadge" class="status-badge status-closed">Caja Cerrada</div>
        </div>
        <div class="pos-layout">
            <div class="products-section">
                <input type="text" id="posSearch" class="search-input" placeholder="üîç Buscar..." autocomplete="off">
                <div class="cat-scroll" id="catNav" style="margin-top:10px;"></div>
                <div class="grid" id="posGrid" style="margin-top:15px;"></div>
            </div>
            <div class="cart-section">
                <div style="padding:15px; border-bottom:1px solid var(--border);"><h3>Ticket</h3></div>
                <div class="cart-list" id="cartItems"></div>
                <div class="cart-total">
                    <div style="display:flex; justify-content:space-between; font-size:1.4rem; font-weight:bold; margin-bottom:10px;">
                        <span>Total</span><span>S/ <span id="cartTotal">0.00</span></span>
                    </div>
                    <button id="btnPay" class="btn-pay" onclick="openPayModal()" disabled>COBRAR</button>
                </div>
            </div>
        </div>
    </div>

    <div id="caja" class="main-content">
        <div class="header"><h2 class="title">Control de Caja</h2><div id="cajaBadge" class="status-badge status-closed">Cerrado</div></div>
        <div class="container-fluid">
            <div id="cajaClosed" class="form-card" style="text-align:center; max-width:400px; margin:40px auto;">
                <h3>üîê Apertura de Caja</h3>
                <div class="input-group" style="text-align:left;"><label>Fondo Inicial (S/)</label><input type="number" id="initAmount" placeholder="0.00"></div><br>
                <button class="btn-primary" style="width:100%" onclick="openSession()">Abrir Turno</button>
            </div>
            <div id="cajaOpen" style="display:none;">
                <div class="stats-row">
                    <div class="stat-box"><div class="stat-label">Inicio</div><div class="stat-val" id="valInit" style="color:#64748b">S/ 0.00</div></div>
                    <div class="stat-box"><div class="stat-label">Ventas Totales</div><div class="stat-val" id="valSalesTotal">S/ 0.00</div></div>
                    <div class="stat-box"><div class="stat-label">Movimientos</div><div class="stat-val" id="valMoves" style="color:var(--warning)">S/ 0.00</div></div>
                    <div class="stat-box" style="background:#fdf4ff;"><div class="stat-label">Efectivo Esperado</div><div class="stat-val" id="valExpected">S/ 0.00</div></div>
                </div>
                <div class="form-card">
                    <h4>üìù Movimientos de Efectivo (Gastos/Ingresos)</h4>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <select id="moveType" style="flex:1;"><option value="out">üî¥ Salida / Gasto</option><option value="in">üü¢ Entrada / Ingreso</option></select>
                        <input type="text" id="moveDesc" placeholder="Motivo" style="flex:2;">
                        <input type="number" id="moveAmount" placeholder="Monto" style="flex:1;">
                        <button class="btn-primary" onclick="addMovement()">Registrar</button>
                    </div>
                    <div style="margin-top:15px;"><strong>Historial:</strong><div class="movements-list" id="moveList"></div></div>
                </div>
                <div class="form-card" style="border-left:5px solid var(--danger);">
                    <h4>üîí Cierre de Turno</h4>
                    <div style="display:flex; gap:10px; align-items:flex-end;">
                        <div class="input-group" style="flex:1;"><label>Efectivo Real (Contado)</label><input type="number" id="endAmount" placeholder="0.00"></div>
                        <button class="btn-primary" style="background:var(--danger);" onclick="closeSession()">Cerrar y PDF</button>
                    </div>
                </div>
            </div>
            <h3>Historial</h3>
            <table style="font-size:0.9rem;"><thead><tr><th>ID</th><th>Inicio</th><th>Ventas</th><th>Diferencia</th><th>PDF</th></tr></thead><tbody id="sessionHistory"></tbody></table>
        </div>
    </div>

    <div id="inv" class="main-content">
        <div class="header"><h2 class="title">Inventario</h2></div>
        <div class="container-fluid">
            <div class="form-card" style="background:#f0fdfa; display:flex; gap:10px; align-items:flex-end;">
                <div class="input-group" style="flex:2;"><label>Scanner Ingreso</label><input type="text" id="stkScan" placeholder="C√≥digo..."></div>
                <div class="input-group"><label>Cant.</label><input type="number" id="stkQty" placeholder="0"></div>
                <button class="btn-primary" onclick="stockIn()">Sumar Stock</button>
            </div>
            <div id="stkPreview" style="margin-bottom:10px;color:#64748b;">Esperando...</div>
            <div class="form-card" style="display:flex; gap:10px; flex-wrap:wrap;">
                <input id="nId" placeholder="ID" style="width:100px;">
                <input id="nName" placeholder="Nombre" style="flex:1;">
                <input id="nCat" placeholder="Cat" list="lCats">
                <input id="nPrice" placeholder="Precio" type="number" style="width:100px;">
                <input id="nStock" placeholder="Stock" type="number" style="width:80px;">
                <select id="nType"><option value="product">Prod</option><option value="service">Serv</option></select>
                <button class="btn-primary" onclick="addProd()">Crear</button>
            </div>
            <datalist id="lCats"></datalist>
            <table><thead><tr><th>ID</th><th>Prod</th><th>Cat</th><th>Precio</th><th>Stock</th><th>Acc</th></tr></thead><tbody id="tInv"></tbody></table>
        </div>
    </div>

    <div id="audit" class="main-content">
        <div class="header"><h2 class="title">Auditor√≠a (Kardex)</h2></div>
        <div class="container-fluid">
            <input type="text" id="auditSearch" placeholder="üîç Filtrar por producto..." class="search-input" onkeyup="renderKardex()" style="margin-bottom:20px;">
            <table>
                <thead><tr><th>Fecha</th><th>Hora</th><th>Producto</th><th>Tipo</th><th>Cant</th><th>Stock Result</th><th>Nota</th></tr></thead>
                <tbody id="tAudit"></tbody>
            </table>
        </div>
    </div>

    <div id="rep" class="main-content">
        <div class="header"><h2 class="title">Reportes</h2></div>
        <div class="container-fluid">
            <table><thead><tr><th>Ticket</th><th>Fecha</th><th>M√©todo</th><th>Total</th><th>Detalle</th></tr></thead><tbody id="tRep"></tbody></table>
        </div>
    </div>

    <div id="payModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>M√©todo de Pago</h3><span onclick="closePayModal()" style="cursor:pointer; font-size:1.5rem">√ó</span></div>
            <div class="modal-body">
                <div style="text-align:center;">Total: <b>S/ <span id="payTotalDisplay">0.00</span></b></div>
                <div class="pay-methods">
                    <button class="btn-method bg-cash" onclick="confirmSale('Efectivo')">üíµ Efectivo</button>
                    <button class="btn-method bg-yape" onclick="confirmSale('Yape')">üì± Yape</button>
                    <button class="btn-method bg-plin" onclick="confirmSale('Plin')">üîÑ Plin</button>
                    <button class="btn-method bg-card" onclick="confirmSale('Tarjeta')">üí≥ Tarjeta</button>
                </div>
            </div>
        </div>
    </div>

    <div id="detModal" class="modal-overlay">
        <div class="modal-content"><div class="modal-header"><h3>Detalle</h3><span onclick="document.getElementById('detModal').classList.remove('open')" style="cursor:pointer">√ó</span></div><div class="modal-body" id="detBody"></div></div>
    </div>

    <div id="print-area"></div>

    <script>
        // DATA
        let db = JSON.parse(localStorage.getItem('pos_db_v14')) || [{id:101, name:"Inca Kola", price:3.00, stock:20, category:"Bebidas", type:"product"}];
        let sales = JSON.parse(localStorage.getItem('pos_sales_v14')) || [];
        let sessions = JSON.parse(localStorage.getItem('pos_sessions_v14')) || [];
        let kardex = JSON.parse(localStorage.getItem('pos_kardex_v14')) || [];

        let cart = [];
        let curTab = 'pos';
        let stockSel = null;

        window.onload = () => { nav('pos'); setupKeys(); };

        function nav(t) {
            curTab = t;
            document.querySelectorAll('.main-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            document.querySelector(`button[onclick="nav('${t}')"]`).classList.add('active');
            if(t==='pos') { renderPOS(); renderCats(); document.getElementById('posSearch').focus(); }
            if(t==='caja') checkCaja();
            if(t==='inv') renderInv();
            if(t==='rep') renderRep();
            if(t==='audit') renderKardex();
        }

        function setupKeys() {
            document.addEventListener('keydown', e => { if(e.target.tagName!=='INPUT'&&e.key.length===1&&curTab==='pos') document.getElementById('posSearch').focus(); });
            document.getElementById('posSearch').addEventListener('keydown', e=>{if(e.key==='Enter') scanPOS(e.target.value)});
            document.getElementById('posSearch').addEventListener('input', ()=>renderPOS());
            document.getElementById('stkScan').addEventListener('keydown', e=>{if(e.key==='Enter') scanStk(e.target.value)});
        }

        // --- KARDEX ENGINE ---
        function logKardex(id, name, type, qty, stock, note) {
            kardex.push({ date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), id, name, type, qty, stock, note });
            saveData();
        }
        function renderKardex() {
            const q = document.getElementById('auditSearch').value.toLowerCase();
            document.getElementById('tAudit').innerHTML = [...kardex].reverse().filter(k=>k.name.toLowerCase().includes(q)).map(k => 
                `<tr><td>${k.date}</td><td>${k.time}</td><td>${k.name}</td>
                <td class="${k.qty>0?'kardex-in':'kardex-out'}">${k.type}</td>
                <td>${k.qty>0?'+':''}${k.qty}</td><td>${k.stock}</td><td>${k.note||'-'}</td></tr>`
            ).join('');
        }

        // --- CAJA ---
        function getActive() { return sessions.find(s=>s.status==='open'); }
        function checkCaja() {
            const act = getActive();
            document.getElementById('posBadge').className = act ? 'status-badge status-open' : 'status-badge status-closed';
            document.getElementById('posBadge').innerText = act ? 'Caja Abierta' : 'Cerrada';
            document.getElementById('cajaBadge').className = document.getElementById('posBadge').className;
            document.getElementById('cajaBadge').innerText = document.getElementById('posBadge').innerText;
            document.getElementById('btnPay').disabled = !act;

            document.getElementById('sessionHistory').innerHTML = [...sessions].reverse().map(s=>`
                <tr><td>#${s.id}</td><td>${new Date(s.start).toLocaleString()}</td><td>S/ ${s.salesTotal.toFixed(2)}</td>
                <td style="color:${s.diff<0?'red':'green'}">${s.diff?s.diff.toFixed(2):'-'}</td>
                <td><button class="btn-sm" style="background:#dc2626;" onclick="downloadPDF(${s.id})">üìÑ PDF</button></td></tr>`).join('');

            if(act) {
                document.getElementById('cajaClosed').style.display='none'; document.getElementById('cajaOpen').style.display='block';
                document.getElementById('valInit').innerText = `S/ ${act.init.toFixed(2)}`;
                document.getElementById('valSalesTotal').innerText = `S/ ${act.salesTotal.toFixed(2)}`;
                document.getElementById('valMoves').innerText = `S/ ${act.moves.toFixed(2)}`;
                act.expected = act.init + (act.salesCash||0) + act.moves;
                document.getElementById('valExpected').innerText = `S/ ${act.expected.toFixed(2)}`;
                document.getElementById('moveList').innerHTML = (act.movements||[]).map(m=>`<div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:5px;"><span>${m.desc}</span><span style="color:${m.type==='in'?'green':'red'}">${m.type==='in'?'+':'-'} S/ ${m.amount.toFixed(2)}</span></div>`).join('');
            } else {
                document.getElementById('cajaClosed').style.display='block'; document.getElementById('cajaOpen').style.display='none';
            }
        }
        function openSession() {
            const v = parseFloat(document.getElementById('initAmount').value);
            if(isNaN(v)) return alert("Monto inv√°lido");
            sessions.push({id:Date.now(), start:new Date().toISOString(), end:null, init:v, salesTotal:0, salesCash:0, salesYape:0, salesPlin:0, salesCard:0, moves:0, expected:v, real:0, diff:0, status:'open', movements:[]});
            saveData(); checkCaja();
            document.getElementById('initAmount').value='';
        }
        function addMovement() {
            const act = getActive(); if(!act) return;
            const t = document.getElementById('moveType').value, d = document.getElementById('moveDesc').value, a = parseFloat(document.getElementById('moveAmount').value);
            if(!d || isNaN(a)) return;
            act.moves += (t==='in'?a:-a);
            act.movements.push({type:t, desc:d, amount:a});
            saveData(); checkCaja();
            document.getElementById('moveDesc').value=''; document.getElementById('moveAmount').value='';
        }
        function closeSession() {
            const act = getActive(); if(!act) return;
            const r = parseFloat(document.getElementById('endAmount').value);
            if(isNaN(r)) return alert("Ingresa monto contado");
            if(!confirm("¬øCerrar Turno?")) return;
            act.real=r; act.diff=r-act.expected; act.end=new Date().toISOString(); act.status='closed';
            saveData(); downloadPDF(act.id); checkCaja();
            document.getElementById('endAmount').value='';
        }

        // --- PDF REPORT ---
        function downloadPDF(sid) {
            const s = sessions.find(x=>x.id===sid);
            if(!s) return;
            
            // Fix undefined for old sessions
            const cash = s.salesCash || 0;
            const yape = s.salesYape || 0;
            const plin = s.salesPlin || 0;
            const card = s.salesCard || 0;
            const movesHtml = (s.movements||[]).map(m=>`<tr><td>${m.desc}</td><td style="text-align:right">${m.type==='in'?'+':'-'} S/ ${m.amount.toFixed(2)}</td></tr>`).join('');

            const html = `
                <div style="padding:20px; font-family:sans-serif; color:#333;">
                    <h2 style="text-align:center; color:#2563eb; margin:0;">REPORTE DE CIERRE</h2>
                    <p style="text-align:center; font-size:12px; margin-top:5px;">ID: ${s.id}</p>
                    <hr>
                    <table style="width:100%; margin-bottom:15px; font-size:13px;">
                        <tr><td>Inicio:</td><td style="text-align:right">${new Date(s.start).toLocaleString()}</td></tr>
                        <tr><td>Fin:</td><td style="text-align:right">${new Date(s.end).toLocaleString()}</td></tr>
                    </table>
                    
                    <h4 style="border-bottom:2px solid #2563eb; margin-bottom:5px;">VENTAS POR M√âTODO</h4>
                    <table style="width:100%; font-size:14px; margin-bottom:15px;">
                        <tr><td>Efectivo:</td><td style="text-align:right">S/ ${cash.toFixed(2)}</td></tr>
                        <tr><td>Yape:</td><td style="text-align:right">S/ ${yape.toFixed(2)}</td></tr>
                        <tr><td>Plin:</td><td style="text-align:right">S/ ${plin.toFixed(2)}</td></tr>
                        <tr><td>Tarjeta:</td><td style="text-align:right">S/ ${card.toFixed(2)}</td></tr>
                        <tr style="font-weight:bold; background:#f1f5f9;"><td>TOTAL VENTAS:</td><td style="text-align:right">S/ ${s.salesTotal.toFixed(2)}</td></tr>
                    </table>

                    <h4 style="border-bottom:2px solid #2563eb; margin-bottom:5px;">BALANCE DE EFECTIVO</h4>
                    <table style="width:100%; font-size:14px; margin-bottom:15px;">
                        <tr><td>(+) Fondo Inicial:</td><td style="text-align:right">S/ ${s.init.toFixed(2)}</td></tr>
                        <tr><td>(+) Ventas Efectivo:</td><td style="text-align:right">S/ ${cash.toFixed(2)}</td></tr>
                        <tr><td>(+/-) Movimientos Caja:</td><td style="text-align:right">S/ ${s.moves.toFixed(2)}</td></tr>
                    </table>

                    ${movesHtml ? `<h5 style="margin:0;">Detalle Movimientos:</h5><table style="width:100%; font-size:12px; margin-bottom:15px; border:1px solid #eee;">${movesHtml}</table>` : ''}

                    <div style="background:#f8fafc; padding:10px; border:1px solid #e2e8f0; border-radius:8px;">
                        <table style="width:100%; font-weight:bold; font-size:15px;">
                            <tr><td>ESPERADO EN CAJ√ìN:</td><td style="text-align:right">S/ ${s.expected.toFixed(2)}</td></tr>
                            <tr><td>DINERO CONTADO:</td><td style="text-align:right">S/ ${(s.real||0).toFixed(2)}</td></tr>
                            <tr style="color:${s.diff<0?'red':'green'}"><td>DIFERENCIA:</td><td style="text-align:right">S/ ${(s.diff||0).toFixed(2)}</td></tr>
                        </table>
                    </div>
                </div>
            `;
            html2pdf().set({margin:10, filename:`Cierre_${s.id}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}}).from(html).save();
        }

        // --- POS ---
        function scanPOS(v) { const p=db.find(x=>x.id.toString()===v.trim()); if(p){if(p.type==='product'&&p.stock<=0)alert("Sin Stock");else addToCart(p.id);document.getElementById('posSearch').value='';renderPOS();} }
        function renderCats() { document.getElementById('catNav').innerHTML=['Todos',...new Set(db.map(p=>p.category||'Varios'))].map(c=>`<button class="cat-btn" onclick="renderPOS('${c}',this)">${c}</button>`).join(''); }
        function renderPOS(cat='Todos', btn=null) {
            if(btn){document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}
            const q = document.getElementById('posSearch').value.toLowerCase();
            document.getElementById('posGrid').innerHTML=db.filter(p=>(cat==='Todos'||p.category===cat)&&(p.name.toLowerCase().includes(q)||p.id.toString().includes(q))).map(p=>
                `<div class="card ${p.type==='product'&&p.stock<=0?'no-stock':''}" onclick="if(${p.type==='service'||p.stock>0}) addToCart(${p.id})">
                    <div class="badge-stock">${p.type==='service'?'SERV':p.stock}</div>
                    <div style="font-weight:600;margin-top:10px;">${p.name}</div>
                    <div class="price-tag">S/ ${p.price.toFixed(2)}</div>
                </div>`).join('');
        }
        function addToCart(id) { const p=db.find(x=>x.id===id), i=cart.find(x=>x.id===id); if(p.type==='product'&&i&&i.qty>=p.stock) return alert("Stock L√≠mite"); if(i)i.qty++; else cart.push({...p,qty:1}); renderCart(); }
        function renderCart() { 
            let t=0; document.getElementById('cartItems').innerHTML=cart.map(i=>{t+=i.price*i.qty; return `<div class="cart-item"><div>${i.name}<br><small>S/ ${i.price}</small></div><div style="display:flex;gap:5px;"><input class="qty-box" type="number" value="${i.qty}" onchange="updQty(${i.id},this.value)"><strong>${(i.price*i.qty).toFixed(2)}</strong><span onclick="updQty(${i.id},0)" style="color:red;cursor:pointer;">√ó</span></div></div>`}).join('');
            document.getElementById('cartTotal').innerText=t.toFixed(2);
        }
        function updQty(id,v) { v=parseInt(v); const p=db.find(x=>x.id===id),i=cart.find(x=>x.id===id); if(v<=0) cart=cart.filter(x=>x.id!==id); else { if(p.type==='product'&&v>p.stock) alert("Stock Insuficiente"); else i.qty=v; } renderCart(); }
        function openPayModal() { if(!cart.length)return alert("Vac√≠o"); document.getElementById('payTotalDisplay').innerText=cart.reduce((a,b)=>a+(b.price*b.qty),0).toFixed(2); document.getElementById('payModal').classList.add('open'); }
        function closePayModal() { document.getElementById('payModal').classList.remove('open'); }
        function confirmSale(m) {
            const act=getActive(); if(!act)return alert("Caja cerrada");
            const t = cart.reduce((a,b)=>a+(b.price*b.qty),0);
            
            act.salesTotal += t;
            if(m==='Efectivo') act.salesCash += t;
            if(m==='Yape') act.salesYape = (act.salesYape||0) + t;
            if(m==='Plin') act.salesPlin = (act.salesPlin||0) + t;
            if(m==='Tarjeta') act.salesCard = (act.salesCard||0) + t;
            act.expected = act.init + act.salesCash + act.moves;

            const sale = {id:Date.now(), date:new Date().toLocaleDateString(), time:new Date().toLocaleTimeString(), items:[...cart], total:t, method:m};
            cart.forEach(c=>{
                if(c.type==='product') {
                    const p = db.find(x=>x.id===c.id);
                    p.stock -= c.qty;
                    logKardex(p.id, p.name, 'VENTA', -c.qty, p.stock, `Ticket #${sale.id}`);
                }
            });
            sales.push(sale); saveData(); printTicket(sale); cart=[]; renderCart(); renderPOS(); checkCaja(); renderRep(); closePayModal();
        }

        // --- INV ---
        function scanStk(v){ const p=db.find(x=>x.id.toString()===v.trim()); if(p){stockSel=p; document.getElementById('stkPreview').innerText=`${p.name} (${p.stock})`; document.getElementById('stkQty').focus();} else alert("No existe"); }
        function stockIn(){ const q=parseInt(document.getElementById('stkQty').value); if(stockSel&&q>0&&stockSel.type==='product'){ stockSel.stock+=q; logKardex(stockSel.id, stockSel.name, 'INGRESO', q, stockSel.stock, 'Manual'); saveData(); renderInv(); alert("Stock +"); } stockSel=null; document.getElementById('stkScan').value=''; document.getElementById('stkQty').value=''; document.getElementById('stkPreview').innerText='Esperando...'; }
        function addProd(){
            const id=document.getElementById('nId').value, name=document.getElementById('nName').value, pr=parseFloat(document.getElementById('nPrice').value);
            if(name&&pr){ db.push({id:id||Date.now(), name, price:pr, stock:parseInt(document.getElementById('nStock').value)||0, category:document.getElementById('nCat').value||'Varios', type:document.getElementById('nType').value}); 
            logKardex(id, name, 'CREACION', parseInt(document.getElementById('nStock').value)||0, parseInt(document.getElementById('nStock').value)||0, 'Nuevo Prod');
            saveData(); renderInv(); }
        }
        function renderInv(){ 
            document.getElementById('tInv').innerHTML=db.map(p=>`<tr><td>${p.id}</td><td>${p.name}</td><td>${p.category}</td><td>${p.price}</td><td>${p.type==='service'?'-':p.stock}</td><td><button onclick="delProd(${p.id})">X</button></td></tr>`).join(''); 
            document.getElementById('lCats').innerHTML=[...new Set(db.map(p=>p.category))].map(c=>`<option value="${c}">`).join('');
        }
        function delProd(id){ if(confirm("Del?")){ const p=db.find(x=>x.id===id); logKardex(p.id, p.name, 'ELIMINACION', -p.stock, 0, 'Borrado Manual'); db=db.filter(x=>x.id!==id); saveData(); renderInv(); } }
        function renderRep(){ document.getElementById('tRep').innerHTML=[...sales].reverse().map(s=>`<tr><td>${s.id}</td><td>${s.date} ${s.time}</td><td>${s.method}</td><td>S/ ${s.total.toFixed(2)}</td><td><button onclick='showDet(${JSON.stringify(s)})'>Ver</button></td></tr>`).join(''); }
        function showDet(s){ document.getElementById('detBody').innerHTML=s.items.map(i=>`<div>${i.qty} ${i.name} ${i.price*i.qty}</div>`).join('')+`<hr>Total: ${s.total}`; document.getElementById('detModal').classList.add('open'); }
        function saveData() { localStorage.setItem('pos_db_v14',JSON.stringify(db)); localStorage.setItem('pos_sales_v14',JSON.stringify(sales)); localStorage.setItem('pos_sessions_v14',JSON.stringify(sessions)); localStorage.setItem('pos_kardex_v14',JSON.stringify(kardex)); }
        function printTicket(s){ document.getElementById('print-area').innerHTML=`<div class="ticket-container"><h3>MARKET</h3>Ticket #${s.id}<br>${s.date} ${s.time}<br>Pago: ${s.method}<hr>${s.items.map(i=>`<div class='t-row'><span>${i.qty} ${i.name}</span><span>${(i.price*i.qty).toFixed(2)}</span></div>`).join('')}<hr><h3 style='text-align:right'>S/ ${s.total.toFixed(2)}</h3></div>`; window.print(); }
    </script>
</body>
</html>