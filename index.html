<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Market POS v19: Caja Restaurada</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #f59e0b;
            --nav-height-mobile: 60px;
            --sidebar-width: 80px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); color: var(--text); margin: 0; 
            height: 100dvh; display: flex; overflow: hidden;
        }

        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* LAYOUT */
        #app-layout { display: none; width: 100%; height: 100%; }
        .sidebar { background: #0f172a; z-index: 100; display: flex; transition: all 0.3s ease; }
        
        @media (min-width: 769px) {
            .sidebar { width: var(--sidebar-width); height: 100%; flex-direction: column; align-items: center; padding-top: 20px; }
            .nav-btn { width: 50px; height: 50px; margin-bottom: 15px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; background: transparent; border: none; cursor: pointer; }
            .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }
            .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); }
            .nav-btn i { font-size: 22px; font-style: normal; } .nav-btn span { font-size: 9px; margin-top: 4px; }
            .logout-btn { margin-top: auto; margin-bottom: 20px; color: #ef4444; }
        }
        @media (max-width: 768px) {
            #app-layout { flex-direction: column; }
            .sidebar { width: 100%; height: var(--nav-height-mobile); flex-direction: row; justify-content: space-around; position: fixed; bottom: 0; left: 0; border-top: 1px solid #1e293b; padding-bottom: env(safe-area-inset-bottom); order: 2; }
            .nav-btn { background: transparent; border: none; color: #94a3b8; flex: 1; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
            .nav-btn.active { color: var(--primary); border-top: 3px solid var(--primary); }
            .nav-btn i { font-size: 20px; } .nav-btn span { font-size: 10px; }
            .logout-btn { position: absolute; top: 15px; right: 15px; color: #ef4444; background: none; border: none; font-weight: bold; z-index: 101; }
        }

        .main-content { flex: 1; display: none; flex-direction: column; height: 100%; overflow: hidden; background: var(--bg); position: relative; }
        .main-content.active { display: flex; }
        .header { height: 50px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; }
        .title { font-size: 1.2rem; font-weight: 800; color: var(--text); margin: 0; }
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
        .status-open { background: #dcfce7; color: #166534; }
        .status-closed { background: #fee2e2; color: #991b1b; }

        /* POS */
        .pos-container { display: flex; flex: 1; overflow: hidden; }
        @media (max-width: 768px) { .main-content { height: calc(100dvh - var(--nav-height-mobile)); } .pos-container { flex-direction: column; } .products-area { height: 60%; } .cart-area { height: 40%; z-index: 50; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); } }
        @media (min-width: 769px) { .products-area { flex: 1; } .cart-area { width: 380px; border-left: 1px solid var(--border); } }

        .products-area { padding: 15px; overflow-y: auto; background: #f1f5f9; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        .card { background: white; padding: 10px; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; height: 100%; position: relative; }
        .card:active { border-color: var(--primary); transform: scale(0.98); }
        .badge-stock { position: absolute; top: 5px; right: 5px; font-size: 0.65rem; background: #e2e8f0; padding: 2px 5px; border-radius: 4px; }
        
        .cart-area { background: var(--surface); display: flex; flex-direction: column; }
        .cart-list { flex: 1; overflow-y: auto; padding: 10px; }
        .cart-footer { padding: 15px; border-top: 1px solid var(--border); background: white; }
        .btn-pay { width: 100%; background: var(--success); color: white; padding: 12px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .btn-pay:disabled { background: #cbd5e1; cursor: not-allowed; }

        /* CAJA & GENERAL */
        .page-container { padding: 15px; overflow-y: auto; height: 100%; }
        .form-card { background: white; padding: 15px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 15px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .stat-box { background: white; padding: 12px; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .stat-val { font-size: 1.3rem; font-weight: 800; color: var(--primary); margin-top: 5px; }
        
        .input-group { margin-bottom: 10px; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; }
        .btn-primary { background: var(--primary); color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        .btn-danger { background: var(--danger); color: white; border:none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }

        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 500px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8fafc; color: #64748b; }
        .table-wrap { overflow-x: auto; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.open { display: flex; }
        .modal-box { background: white; width: 90%; max-width: 400px; border-radius: 12px; overflow: hidden; }
        .pay-methods { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
        .pay-btn { padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: white; font-weight: bold; cursor: pointer; }

        #print-area { display: none; }
        @media print { @page { margin: 0; } body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; font-family: monospace; font-size: 12px; padding: 10px; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-bottom:20px;">MARKET POS</h2>
            <input type="text" id="loginUser" class="login-input" placeholder="Usuario (admin)">
            <input type="password" id="loginPass" class="login-input" placeholder="Contrase√±a (1234)">
            <button class="login-btn" onclick="login()">INGRESAR</button>
        </div>
    </div>

    <div id="app-layout">
        <nav class="sidebar" id="sidebarMenu"></nav>

        <section id="pos" class="main-content">
            <div class="header">
                <div class="title">Ventas</div>
                <div class="status-badge status-closed" id="posBadge">Cerrado</div>
                <button class="logout-btn btn-danger" onclick="logout()" style="display:none">Salir</button>
            </div>
            <div class="pos-container">
                <div class="products-area">
                    <input type="text" id="posSearch" placeholder="üîç Buscar..." class="login-input" style="margin-bottom:10px;">
                    <div class="grid" id="posGrid"></div>
                </div>
                <div class="cart-area">
                    <div style="padding:10px; border-bottom:1px solid #eee; font-weight:bold;">Ticket</div>
                    <div class="cart-list" id="cartItems"></div>
                    <div class="cart-footer">
                        <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:bold; margin-bottom:10px;">
                            <span>Total</span><span>S/ <span id="cartTotal">0.00</span></span>
                        </div>
                        <button id="btnPay" class="btn-pay" onclick="openPayModal()" disabled>COBRAR</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="caja" class="main-content">
            <div class="header"><div class="title">Caja</div><div class="status-badge status-closed" id="cajaBadge">Cerrado</div></div>
            <div class="page-container">
                <div id="cajaClosed" class="form-card" style="text-align:center;">
                    <h3>üîê Apertura de Turno</h3>
                    <input type="number" id="initAmount" placeholder="Fondo Inicial (S/)" class="login-input">
                    <button class="btn-primary" style="width:100%" onclick="openSession()">ABRIR CAJA</button>
                </div>

                <div id="cajaOpen" style="display:none;">
                    <div class="stats-grid">
                        <div class="stat-box"><div>Inicio</div><div class="stat-val" style="color:#64748b" id="valInit">0.00</div></div>
                        <div class="stat-box"><div>Ventas Totales</div><div class="stat-val" style="color:var(--primary)" id="valSalesTotal">0.00</div></div>
                        <div class="stat-box"><div>Movimientos</div><div class="stat-val" style="color:var(--warning)" id="valMoves">0.00</div></div>
                        <div class="stat-box" style="background:#f0fdfa; border-color:var(--success)"><div>En Caja (Efectivo)</div><div class="stat-val" style="color:var(--success)" id="valExpected">0.00</div></div>
                    </div>

                    <div class="form-card">
                        <h4>üìù Registrar Movimiento</h4>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <select id="moveType" style="flex:1;"><option value="out">üî¥ Gasto / Salida</option><option value="in">üü¢ Ingreso / Sencillo</option></select>
                            <input type="text" id="moveDesc" placeholder="Motivo" style="flex:2;">
                            <input type="number" id="moveAmount" placeholder="Monto" style="width:80px;">
                            <button class="btn-primary" onclick="addMovement()">OK</button>
                        </div>
                        <div id="moveList" style="margin-top:10px; max-height:100px; overflow-y:auto; border-top:1px solid #eee; padding-top:5px; font-size:0.85rem;"></div>
                    </div>

                    <div class="form-card" style="border-left:4px solid var(--danger);">
                        <h4>üîí Cierre de Turno</h4>
                        <div style="display:flex; gap:10px; align-items:flex-end;">
                            <div style="flex:1;"><label style="font-size:0.8rem; font-weight:bold;">Efectivo Real (Contado)</label><input type="number" id="endAmount" class="login-input" style="margin:0;"></div>
                            <button class="btn-danger" style="height:46px; font-size:1rem;" onclick="closeSession()">CERRAR TURNO</button>
                        </div>
                    </div>
                </div>

                <h3>Historial</h3>
                <div class="table-wrap">
                    <table><thead><tr><th>ID</th><th>Inicio</th><th>Fin</th><th>Ventas</th><th>Dif.</th><th>Reporte</th></tr></thead><tbody id="sessionHistory"></tbody></table>
                </div>
            </div>
        </section>

        <section id="inv" class="main-content">
            <div class="header"><div class="title">Inventario</div></div>
            <div class="page-container">
                <div class="form-card">
                    <div style="display:flex; gap:5px; flex-wrap:wrap;">
                        <input id="nId" placeholder="ID" style="width:60px;">
                        <input id="nName" placeholder="Producto" style="flex:1;">
                        <input id="nPrice" placeholder="$" type="number" style="width:60px;">
                        <input id="nStock" placeholder="#" type="number" style="width:50px;">
                        <button class="btn-primary" onclick="addProd()">Crear</button>
                    </div>
                </div>
                <div class="table-wrap"><table><thead><tr><th>Prod</th><th>$</th><th>Stk</th><th>Acc</th></tr></thead><tbody id="tInv"></tbody></table></div>
            </div>
        </section>

        <section id="audit" class="main-content">
            <div class="header"><div class="title">Kardex</div></div>
            <div class="page-container">
                <div class="table-wrap"><table><thead><tr><th>Fecha</th><th>Prod</th><th>Mov</th><th>Cant</th><th>Usr</th></tr></thead><tbody id="tAudit"></tbody></table></div>
            </div>
        </section>

        <section id="rep" class="main-content">
            <div class="header"><div class="title">Reportes</div></div>
            <div class="page-container">
                <div class="table-wrap"><table><thead><tr><th>#</th><th>Fecha</th><th>Total</th><th>Pago</th></tr></thead><tbody id="tRep"></tbody></table></div>
            </div>
        </section>

        <section id="config" class="main-content">
            <div class="header"><div class="title">Config</div></div>
            <div class="page-container">
                <div class="form-card">
                    <h4>Usuarios</h4>
                    <input id="uName" placeholder="Usuario"> <input id="uPass" placeholder="Clave">
                    <button class="btn-primary" onclick="addUser()">Crear</button>
                    <div id="userList" style="margin-top:10px;"></div>
                </div>
            </div>
        </section>
    </div>

    <div id="payModal" class="modal-overlay">
        <div class="modal-box">
            <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <b>Total: S/ <span id="payTotalDisplay">0.00</span></b> <span onclick="closePayModal()" style="font-size:1.5rem;cursor:pointer;">√ó</span>
            </div>
            <div class="pay-methods">
                <button class="pay-btn" onclick="confirmSale('Efectivo')">üíµ Efectivo</button>
                <button class="pay-btn" onclick="confirmSale('Yape')">üì± Yape</button>
                <button class="pay-btn" onclick="confirmSale('Plin')">üîÑ Plin</button>
                <button class="pay-btn" onclick="confirmSale('Tarjeta')">üí≥ Tarjeta</button>
            </div>
        </div>
    </div>

    <div id="print-area"></div>

    <script>
        // --- DB ---
        const defRoles = [{id:1,name:'Admin',perms:['pos','caja','inv','audit','rep','config']},{id:2,name:'Cajero',perms:['pos','caja']}];
        const defUsers = [{id:1,name:'admin',pass:'1234',roleId:1}];
        
        let db = JSON.parse(localStorage.getItem('pos_db_v19')) || [{id:101,name:"Agua 500ml",price:1.5,stock:50,type:'product'}];
        let users = JSON.parse(localStorage.getItem('pos_users_v19')) || defUsers;
        let roles = JSON.parse(localStorage.getItem('pos_roles_v19')) || defRoles;
        let sales = JSON.parse(localStorage.getItem('pos_sales_v19')) || [];
        let sessions = JSON.parse(localStorage.getItem('pos_sessions_v19')) || [];
        let kardex = JSON.parse(localStorage.getItem('pos_kardex_v19')) || [];
        
        let curUser=null, curRole=null, cart=[], curTab='pos';

        // --- AUTH ---
        function login(){
            const u=document.getElementById('loginUser').value, p=document.getElementById('loginPass').value;
            const usr=users.find(x=>x.name===u && x.pass===p);
            if(usr){
                curUser=usr; curRole=roles.find(r=>r.id==usr.roleId);
                document.getElementById('login-screen').style.display='none';
                document.getElementById('app-layout').style.display='flex';
                buildNav();
                nav(curRole.perms[0]);
            }else alert("Error");
        }
        function logout(){ location.reload(); }
        
        function buildNav(){
            const menu=document.getElementById('sidebarMenu'); menu.innerHTML='';
            const mods=[{id:'pos',i:'üõí',l:'Ventas'},{id:'caja',i:'üè™',l:'Caja'},{id:'inv',i:'üì¶',l:'Stock'},{id:'audit',i:'üëÅÔ∏è',l:'Kardex'},{id:'rep',i:'üìä',l:'Rep'},{id:'config',i:'‚öôÔ∏è',l:'Conf'}];
            mods.forEach(m=>{
                if(curRole.perms.includes(m.id)){
                    const b=document.createElement('button'); b.className='nav-btn'; b.onclick=()=>nav(m.id); b.innerHTML=`<i>${m.i}</i><span>${m.l}</span>`;
                    menu.appendChild(b);
                }
            });
            if(window.innerWidth>768) menu.innerHTML+=`<button class="nav-btn logout-btn" onclick="logout()"><i>üö™</i><span>Salir</span></button>`;
        }

        function nav(t){
            document.querySelectorAll('.main-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
            if(document.getElementById(t)){
                document.getElementById(t).classList.add('active');
                const btn=Array.from(document.querySelectorAll('.nav-btn')).find(b=>b.innerHTML.includes(t=='pos'?'Ventas':t=='caja'?'Caja':t=='inv'?'Stock':t=='audit'?'Kardex':t=='rep'?'Rep':'Conf'));
                if(btn) btn.classList.add('active');
                if(t=='pos')renderPOS(); if(t=='caja')checkCaja(); if(t=='inv')renderInv(); if(t=='audit')renderAudit(); if(t=='rep')renderRep(); if(t=='config')renderConfig();
            }
        }

        // --- POS ---
        function renderPOS(){
            const q=document.getElementById('posSearch').value.toLowerCase();
            document.getElementById('posGrid').innerHTML=db.filter(p=>p.name.toLowerCase().includes(q)).map(p=>`
                <div class="card ${p.stock<=0?'no-stock':''}" onclick="if(${p.stock>0})addCart(${p.id})">
                    <div class="badge-stock">${p.stock}</div>
                    <div style="font-weight:bold;font-size:0.9rem;">${p.name}</div>
                    <div class="price-tag">S/ ${p.price.toFixed(2)}</div>
                </div>`).join('');
        }
        function addCart(id){
            const i=cart.find(x=>x.id===id), p=db.find(x=>x.id===id);
            if(i && i.qty>=p.stock) return alert("Max stock");
            if(i) i.qty++; else cart.push({...p, qty:1});
            renderCart();
        }
        function renderCart(){
            let t=0; document.getElementById('cartItems').innerHTML=cart.map(i=>{ t+=i.price*i.qty; return `<div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px dashed #eee;"><span>${i.name}</span><span>${i.qty} x ${i.price}</span></div>`}).join('');
            document.getElementById('cartTotal').innerText=t.toFixed(2);
            document.getElementById('btnPay').disabled = cart.length===0;
        }
        function openPayModal(){ document.getElementById('payTotalDisplay').innerText=document.getElementById('cartTotal').innerText; document.getElementById('payModal').classList.add('open'); }
        function closePayModal(){ document.getElementById('payModal').classList.remove('open'); }
        
        function confirmSale(m){
            const act=sessions.find(s=>s.status==='open'); if(!act)return alert("Caja cerrada");
            const t=parseFloat(document.getElementById('cartTotal').innerText);
            
            // LOGICA CAJA RESTAURADA
            act.salesTotal += t;
            if(m==='Efectivo') act.salesCash = (act.salesCash||0) + t;
            // Solo efectivo suma al cajon
            act.expected = act.init + (act.salesCash||0) + act.moves;

            const sale = {id:Date.now(), date:new Date().toLocaleString(), items:[...cart], total:t, method:m, user:curUser.name};
            sales.push(sale);
            
            cart.forEach(c=>{ 
                const p=db.find(x=>x.id===c.id); p.stock-=c.qty;
                logKardex(p.id, p.name, 'VENTA', -c.qty, p.stock, `T-${sale.id}`);
            });
            
            saveData(); printTicket(sale); cart=[]; renderCart(); renderPOS(); closePayModal(); checkCaja();
        }

        // --- CAJA ---
        function checkCaja(){
            const act = sessions.find(s=>s.status==='open');
            const status = act ? 'Abierto' : 'Cerrado';
            document.getElementById('posBadge').innerText = status; document.getElementById('posBadge').className = act?'status-badge status-open':'status-badge status-closed';
            document.getElementById('cajaBadge').innerText = status; document.getElementById('cajaBadge').className = document.getElementById('posBadge').className;
            
            // Historial
            document.getElementById('sessionHistory').innerHTML=[...sessions].reverse().map(s=>`
                <tr><td>${s.id}</td><td>${new Date(s.start).toLocaleTimeString()}</td><td>${s.end?new Date(s.end).toLocaleTimeString():'-'}</td><td>S/ ${s.salesTotal.toFixed(2)}</td><td>${s.diff?s.diff.toFixed(2):'-'}</td><td><button class="btn-danger" style="padding:2px 5px;" onclick="pdf(${s.id})">PDF</button></td></tr>
            `).join('');

            if(act){
                document.getElementById('cajaClosed').style.display='none'; document.getElementById('cajaOpen').style.display='block';
                document.getElementById('valInit').innerText = act.init.toFixed(2);
                document.getElementById('valSalesTotal').innerText = act.salesTotal.toFixed(2);
                document.getElementById('valMoves').innerText = act.moves.toFixed(2);
                document.getElementById('valExpected').innerText = act.expected.toFixed(2);
                document.getElementById('moveList').innerHTML = (act.movements||[]).map(m=>`<div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;"><span>${m.desc}</span><span style="color:${m.type=='in'?'green':'red'}">${m.type=='in'?'+':'-'} ${m.amount}</span></div>`).join('');
            }else{
                document.getElementById('cajaClosed').style.display='block'; document.getElementById('cajaOpen').style.display='none';
            }
        }
        function openSession(){ const v=parseFloat(document.getElementById('initAmount').value); if(isNaN(v))return; sessions.push({id:Date.now(),start:new Date(),init:v,salesTotal:0,salesCash:0,moves:0,expected:v,status:'open',movements:[]}); saveData(); checkCaja(); }
        function addMovement(){ const act=sessions.find(s=>s.status=='open'); if(!act)return; const t=document.getElementById('moveType').value, d=document.getElementById('moveDesc').value, a=parseFloat(document.getElementById('moveAmount').value); if(!d||isNaN(a))return; act.moves+=(t=='in'?a:-a); act.movements.push({type:t,desc:d,amount:a}); saveData(); checkCaja(); document.getElementById('moveDesc').value=''; document.getElementById('moveAmount').value='';}
        function closeSession(){ const act=sessions.find(s=>s.status=='open'); if(!act)return; const r=parseFloat(document.getElementById('endAmount').value); if(isNaN(r))return alert("Monto real?"); if(!confirm("Cerrar?"))return; act.real=r; act.diff=r-act.expected; act.end=new Date(); act.status='closed'; saveData(); pdf(act.id); checkCaja(); }
        function pdf(sid){
            const s=sessions.find(x=>x.id==sid); if(!s)return;
            const h=`<div style="padding:20px;font-family:sans-serif;"><h3>CIERRE #${s.id}</h3><p>${new Date(s.start).toLocaleString()} - ${s.end?new Date(s.end).toLocaleString():'Act'}</p><hr><table><tr><td>Ventas Tot:</td><td align="right">${s.salesTotal.toFixed(2)}</td></tr><tr><td>Efec:</td><td align="right">${(s.salesCash||0).toFixed(2)}</td></tr></table><hr><table><tr><td>Inicio:</td><td align="right">${s.init.toFixed(2)}</td></tr><tr><td>Movs:</td><td align="right">${s.moves.toFixed(2)}</td></tr><tr><td><b>ESPERADO:</b></td><td align="right"><b>${s.expected.toFixed(2)}</b></td></tr><tr><td>REAL:</td><td align="right">${(s.real||0).toFixed(2)}</td></tr><tr><td>DIF:</td><td align="right">${(s.diff||0).toFixed(2)}</td></tr></table></div>`;
            html2pdf().set({margin:5,filename:`Cierre_${s.id}.pdf`,image:{type:'jpeg',quality:0.98},html2canvas:{scale:2},jsPDF:{unit:'mm',format:'80mm'}}).from(h).save();
        }

        // --- INV & OTHERS ---
        function addProd(){ const n=document.getElementById('nName').value, p=parseFloat(document.getElementById('nPrice').value); if(n&&p){ db.push({id:Date.now(),name:n,price:p,stock:parseInt(document.getElementById('nStock').value)||0,type:'product'}); logKardex(0,n,'CREAR',0,0,'Nuevo'); saveData(); renderInv(); } }
        function renderInv(){ document.getElementById('tInv').innerHTML=db.map(p=>`<tr><td>${p.name}</td><td>${p.price}</td><td>${p.stock}</td><td><button class="btn-danger" onclick="delProd(${p.id})">X</button></td></tr>`).join(''); }
        function delProd(id){ if(confirm("Del?")){db=db.filter(x=>x.id!==id);saveData();renderInv();} }
        function logKardex(id,n,t,q,s,no){ kardex.push({date:new Date().toLocaleString(),name:n,type:t,qty:q,stock:s,usr:curUser.name}); saveData(); }
        function renderAudit(){ document.getElementById('tAudit').innerHTML=[...kardex].reverse().map(k=>`<tr><td>${k.date}</td><td>${k.name}</td><td>${k.type}</td><td>${k.qty}</td><td>${k.usr}</td></tr>`).join(''); }
        function renderRep(){ document.getElementById('tRep').innerHTML=[...sales].reverse().map(s=>`<tr><td>${s.id}</td><td>${s.date}</td><td>${s.total}</td><td>${s.method}</td></tr>`).join(''); }
        function renderConfig(){ document.getElementById('userList').innerHTML=users.map(u=>`<div>${u.name} (${roles.find(r=>r.id==u.roleId)?.name})</div>`).join(''); }
        function addUser(){ const n=document.getElementById('uName').value, p=document.getElementById('uPass').value; if(n&&p){ users.push({id:Date.now(),name:n,pass:p,roleId:2}); saveData(); renderConfig(); } }

        function saveData(){ localStorage.setItem('pos_db_v19',JSON.stringify(db)); localStorage.setItem('pos_sales_v19',JSON.stringify(sales)); localStorage.setItem('pos_sessions_v19',JSON.stringify(sessions)); localStorage.setItem('pos_kardex_v19',JSON.stringify(kardex)); localStorage.setItem('pos_users_v19',JSON.stringify(users)); }
        function printTicket(s){ document.getElementById('print-area').innerHTML=`<div style="width:200px;font-family:monospace;font-size:12px;">MARKET<br>Ticket #${s.id}<br>${s.date}<hr>${s.items.map(i=>`${i.qty} ${i.name} ${i.price*i.qty}`).join('<br>')}<hr>Tot: S/ ${s.total.toFixed(2)}<br>Pago: ${s.method}<br>Cajero: ${s.user}</div>`; window.print(); }
        
        document.getElementById('posSearch').addEventListener('keyup', renderPOS);
    </script>
</body>
</html>
